// src/Pages/Projects/ProjectCreate.tsx

import React, { useEffect, useState } from 'react';
import {
  Create,
  SimpleForm,
  TextInput,
  NumberInput,
  DateInput,

  useRedirect,
  useDataProvider,
  Toolbar,
  SaveButton,
  FormDataConsumer,
  SelectInput,

} from 'react-admin';
import { Typography } from '@mui/material';
import { Project } from '../../interfaces/Project';
import { DataProvider } from 'react-admin';

export const ProjectCreate = (props: any) => {
  const redirect = useRedirect();
  const dataProvider: DataProvider = useDataProvider();

  // Custom Toolbar
  const MyToolbar = (props: any) => (
    <Toolbar {...props}>
      <SaveButton
        mutationOptions={{
          onSuccess: () => {
            redirect('/projects');
          },
        }}
      />
    </Toolbar>
  );

  return (
    <Create {...props}>
      <SimpleForm toolbar={<MyToolbar />}>
        <ProjectFormFields dataProvider={dataProvider} />
      </SimpleForm>
    </Create>
  );
};

const ProjectFormFields = ({ dataProvider }: { dataProvider: DataProvider }) => {
  const [maxAssignable, setMaxAssignable] = useState<number>(100);



  // Function to get total assigned percentage
  const getTotalAssignedPercentage = async (): Promise<number> => {
    const projects = await dataProvider.getList<Project>('projects', {
      pagination: { page: 1, perPage: 1000 },
      sort: { field: 'id', order: 'ASC' },
      filter: {},
    });

    const totalAssigned = projects.data.reduce(
      (sum: number, project: Project) => sum + (project.porcentajeAsignado || 0),
      0
    );

    return totalAssigned;
  };

  // Validation of assigned percentage
  const validatePorcentaje = async (value: number) => {
    const totalAssigned = await getTotalAssignedPercentage();
    const maxAssignablePercentage = 100 - totalAssigned;

    if (value > maxAssignablePercentage) {
      return `El porcentaje máximo que puedes asignar es ${maxAssignablePercentage}%.`;
    }

    return undefined;
  };

  return (
    <>
      <TextInput source="nombre" label="Nombre" fullWidth />
      <TextInput source="descripcion" label="Descripción" multiline fullWidth />
      <NumberInput source="nivelUrgencia" label="Nivel de Urgencia" />
      <DateInput source="fechaInicio" label="Fecha de Inicio" />
      <DateInput source="fechaFinEstimada" label="Fecha de Fin Estimada" />
      <NumberInput source="costoTotal" label="Costo Total" />
      <FormDataConsumer>
        {({ formData, ...rest }) => {
          useEffect(() => {
            const fetchMaxAssignable = async () => {
              const totalAssigned = await getTotalAssignedPercentage();
              setMaxAssignable(100 - (totalAssigned + (formData.porcentajeAsignado || 0)));
            };
            fetchMaxAssignable();
          }, [formData.porcentajeAsignado]);

          return (
            <>
              <NumberInput
                source="porcentajeAsignado"
                label="Porcentaje Asignado"
                validate={validatePorcentaje}
              />
              <Typography variant="body2">
                Porcentaje restante disponible: {maxAssignable}%
              </Typography>
            </>
          );
        }}
        

      </FormDataConsumer>
      <TextInput source="ubicacion" label="Ubicación" fullWidth />

      <SelectInput
        source="estado"
        label="Estado"
        choices={[
          { id: 'en progreso', name: 'En Progreso' },
          { id: 'finalizado', name: 'Finalizado' },
          { id: 'fondos suficientes', name: 'Fondos Suficientes' },
        ]}
        defaultValue="en progreso" // Set default value here
      />
    </>
  );
};